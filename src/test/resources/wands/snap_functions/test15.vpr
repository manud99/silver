field f: Int

method test0b(xs: Seq[Ref], y: Ref)
  requires forall x: Ref :: x in xs ==> acc(x.f)
  requires forall i: Int, j: Int :: 0 <= i && 0 <= j && i < |xs| && j < |xs| && i != j ==> xs[i] != xs[j]
  requires |xs| >= 1
  requires acc(y.f)
{
  xs[0].f := 0
  y.f := 1

  label setupComplete
  var toGo: Seq[Ref] := xs
  var completed: Seq[Ref] := Seq()

  var localX: Ref := toGo[0]
  package acc(y.f) --* acc(localX.f) && acc(y.f) && y.f == old[lhs](y.f)
  completed := completed ++ Seq(localX)
  toGo := toGo[1..]

  assert forall x: Ref :: x in completed ==> applying (acc(y.f) --* acc(x.f) && acc(y.f) && y.f == old[lhs](y.f)) in x.f == old[setupComplete](x.f)
}

method test0c(xs: Seq[Ref], y: Ref)
  requires forall x: Ref :: x in xs ==> acc(x.f)
  requires |xs| >= 1
  requires acc(y.f)
{
  var localX: Ref := xs[0]

  var toGo: Seq[Ref] := xs[1..]
  var completed: Seq[Ref] := Seq(localX)

  package acc(y.f) --* acc(localX.f) && acc(y.f) && y.f == old[lhs](y.f)

  assert forall x: Ref :: x in completed ==> applying (acc(y.f) --* acc(x.f) && acc(y.f) && y.f == old[lhs](y.f)) in x.f == old(x.f)
}

method test0d(xs: Seq[Ref], y: Ref)
  requires forall x: Ref :: x in xs ==> acc(x.f)
  requires |xs| >= 1
  requires acc(y.f)
{
  xs[0].f := 0
  y.f := 1
  label setupComplete

  var completed: Seq[Ref] := Seq(xs[0])

  package acc(y.f) --* acc(xs[0].f) && acc(y.f) && y.f == old[lhs](y.f)

  assert forall x: Ref :: x in completed ==> applying (acc(y.f) --* acc(x.f) && acc(y.f) && y.f == old[lhs](y.f)) in x.f == old[setupComplete](x.f)
}
